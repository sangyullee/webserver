<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OATS í™˜ê²½ ê´€ì œ í†µí•© ë§ˆìŠ¤í„° v2.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;900&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #020617; color: #f8fafc; overflow-x: hidden; }
        .glass-card { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 1.5rem; cursor: default; transition: all 0.3s ease; }
        .draggable-handle { cursor: move; }
        .status-pulse { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .online { background-color: #10b981; box-shadow: 0 0 15px #10b981; }
        .offline { background-color: #ef4444; box-shadow: 0 0 15px #ef4444; }
        .connecting { background-color: #f59e0b; box-shadow: 0 0 15px #f59e0b; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .input-dark { background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.1); color: white; padding: 0.75rem; border-radius: 0.75rem; font-size: 0.875rem; }
        .hidden-panel { display: none !important; }
        .section-title { font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.15em; color: #94a3b8; margin-bottom: 1.25rem; display: flex; align-items: center; gap: 0.5rem; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .stat-value { font-size: 2.25rem; font-weight: 900; line-height: 1; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 11px; cursor: pointer; padding: 4px 8px; border-radius: 6px; transition: background 0.2s; }
        .legend-item:hover { background: rgba(255,255,255,0.05); }
        
        .data-table-container { height: 215px; overflow-y: auto; border-radius: 0.75rem; background: rgba(0,0,0,0.2); }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { position: sticky; top: 0; background: #1e293b; color: #94a3b8; text-align: left; padding: 8px 12px; font-weight: 800; text-transform: uppercase; }
        td { padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.03); color: #cbd5e1; }
        tr:hover { background: rgba(255,255,255,0.02); }

        /* ì²´í¬ë°•ìŠ¤ ë””ìì¸ */
        .view-checkbox { accent-color: #3b82f6; width: 1rem; height: 1rem; cursor: pointer; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-slate-900 via-slate-950 to-black text-slate-200">
    <div id="appContainer" class="max-w-[1600px] mx-auto space-y-6">
        <header class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
            <div class="space-y-2">
                <div class="flex items-center gap-3">
                    <h1 class="text-3xl font-black tracking-tighter text-white uppercase italic">OATS <span class="text-blue-500">MASTER</span></h1>
                </div>
                <div class="flex items-center gap-4 bg-slate-900/50 p-2 rounded-2xl border border-white/5">
                    <select id="deviceSelector" class="bg-transparent border-none text-blue-400 font-bold text-sm focus:ring-0 cursor-pointer" onchange="changeDevice(this.value)">
                        <option value="">ê¸°ê¸° ê²€ìƒ‰ ì¤‘...</option>
                    </select>
                    <div class="h-4 w-[1px] bg-slate-700"></div>
                    <div class="flex items-center gap-2 px-2">
                        <div id="connStatus" class="status-pulse offline"></div>
                        <span id="statusText" class="text-[11px] font-black text-slate-500 uppercase tracking-tighter">Disconnected</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="togglePanel('layoutPanel')" class="bg-slate-800 hover:bg-slate-700 text-white px-5 py-2.5 rounded-xl text-xs font-bold transition-all border border-white/5 shadow-xl">í™”ë©´ êµ¬ì„± ì„¤ì •</button>
                <button onclick="togglePanel('configPanel')" class="bg-slate-800 hover:bg-slate-700 text-white px-5 py-2.5 rounded-xl text-xs font-bold transition-all border border-white/5 shadow-xl">MQTT/í† í”½ ì„¤ì •</button>
                <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2.5 rounded-xl text-xs font-bold transition-all shadow-lg shadow-blue-900/20">ì‹œìŠ¤í…œ ë¦¬ì…‹</button>
            </div>
        </header>

        <!-- ë ˆì´ì•„ì›ƒ ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
        <section id="layoutPanel" class="hidden-panel glass-card p-6 border-t-4 border-emerald-500 shadow-2xl">
            <span class="section-title mb-4">Display Visibility Control</span>
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                <label class="flex items-center gap-3 cursor-pointer bg-white/5 p-3 rounded-xl hover:bg-white/10 transition">
                    <input type="checkbox" checked onchange="toggleVisibility('card-temp', this.checked)" class="view-checkbox">
                    <span class="text-xs font-bold">Temperature</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer bg-white/5 p-3 rounded-xl hover:bg-white/10 transition">
                    <input type="checkbox" checked onchange="toggleVisibility('card-humi', this.checked)" class="view-checkbox">
                    <span class="text-xs font-bold">Humidity</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer bg-white/5 p-3 rounded-xl hover:bg-white/10 transition">
                    <input type="checkbox" checked onchange="toggleVisibility('card-co2', this.checked)" class="view-checkbox">
                    <span class="text-xs font-bold">CO2</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer bg-white/5 p-3 rounded-xl hover:bg-white/10 transition">
                    <input type="checkbox" checked onchange="toggleVisibility('card-pm25', this.checked)" class="view-checkbox">
                    <span class="text-xs font-bold">PM 2.5</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer bg-white/5 p-3 rounded-xl hover:bg-white/10 transition">
                    <input type="checkbox" checked onchange="toggleVisibility('card-noise', this.checked)" class="view-checkbox">
                    <span class="text-xs font-bold">Noise</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer bg-white/5 p-3 rounded-xl hover:bg-white/10 transition">
                    <input type="checkbox" checked onchange="toggleVisibility('graph-1', this.checked)" class="view-checkbox">
                    <span class="text-xs font-bold">Env Trend</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer bg-white/5 p-3 rounded-xl hover:bg-white/10 transition">
                    <input type="checkbox" checked onchange="toggleVisibility('graph-2', this.checked)" class="view-checkbox">
                    <span class="text-xs font-bold">Air Quality</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer bg-white/5 p-3 rounded-xl hover:bg-white/10 transition">
                    <input type="checkbox" checked onchange="toggleVisibility('data-logs', this.checked)" class="view-checkbox">
                    <span class="text-xs font-bold">Data Logs</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer bg-white/5 p-3 rounded-xl hover:bg-white/10 transition">
                    <input type="checkbox" checked onchange="toggleVisibility('ai-control', this.checked)" class="view-checkbox">
                    <span class="text-xs font-bold">AI & Control</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer bg-white/5 p-3 rounded-xl hover:bg-white/10 transition">
                    <input type="checkbox" checked onchange="toggleVisibility('sys-logs', this.checked)" class="view-checkbox">
                    <span class="text-xs font-bold">System Logs</span>
                </label>
            </div>
        </section>

        <section id="configPanel" class="hidden-panel glass-card p-8 border-t-4 border-blue-500 shadow-2xl">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <h3 class="text-sm font-black text-white uppercase tracking-widest">Connection & Topic Settings</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2">
                            <label class="text-[10px] text-slate-500 font-bold ml-1 uppercase">Broker Host</label>
                            <input type="text" id="mqttHost" class="input-dark w-full mt-1" placeholder="ì˜ˆ: broker.hivemq.com">
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 font-bold ml-1 uppercase">Port</label>
                            <input type="text" id="mqttPort" class="input-dark w-full mt-1">
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 font-bold ml-1 uppercase">User (Optional)</label>
                            <input type="text" id="mqttUser" class="input-dark w-full mt-1">
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 font-bold ml-1 uppercase">Pass (Optional)</label>
                            <input type="password" id="mqttPass" class="input-dark w-full mt-1">
                        </div>
                        <div class="col-span-2">
                            <label class="text-[10px] text-emerald-400 font-bold ml-1 uppercase italic">Data Topic (ìˆ˜ì‹  í† í”½)</label>
                            <input type="text" id="mqttDataTopic" class="input-dark w-full mt-1 border-emerald-900/50" placeholder="huenrix/sensors/data">
                        </div>
                        <div class="col-span-2">
                            <label class="text-[10px] text-blue-400 font-bold ml-1 uppercase italic">Control Topic (ì›ê²© ì œì–´ í† í”½)</label>
                            <input type="text" id="mqttCtrlTopic" class="input-dark w-full mt-1 border-blue-900/50" placeholder="huenrix/control/power">
                        </div>
                    </div>
                    <button onclick="saveAndReconnect()" class="w-full bg-blue-600 py-3 rounded-xl font-bold text-sm shadow-lg shadow-blue-600/20">ì„¤ì • ì €ì¥ ë° ë‹¤ì‹œ ì—°ê²°</button>
                </div>
                <div class="text-xs text-slate-400 flex flex-col justify-center bg-white/5 p-6 rounded-xl leading-relaxed space-y-2">
                    <p class="text-white font-bold underline underline-offset-4 decoration-blue-500 mb-2">ë„ì›€ë§</p>
                    <p>â€¢ <b>HOST</b>: MQTT ë¸Œë¡œì»¤ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
                    <p>â€¢ <b>DATA TOPIC</b>: ì„¼ì„œ ë°ì´í„°ë¥¼ ìˆ˜ì‹ í•˜ëŠ” í† í”½ì…ë‹ˆë‹¤.</p>
                    <p>â€¢ <b>CONTROL TOPIC</b>: ê¸°ê¸°ë¥¼ ì œì–´í•  ë•Œ ì‚¬ìš©í•˜ëŠ” í† í”½ì…ë‹ˆë‹¤.</p>
                    <p>â€¢ ëª¨ë“  ì„¤ì •ì€ ë¸Œë¼ìš°ì €ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤.</p>
                </div>
            </div>
        </section>

        <div id="sortableCards" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
            <div id="card-temp" class="glass-card p-5 border-b-2 border-orange-500/30 draggable-handle" data-id="card-temp">
                <span class="section-title"><div class="w-1.5 h-1.5 rounded-full bg-orange-500"></div>Temperature</span>
                <div class="flex items-baseline justify-center gap-1"><span id="val-temp" class="stat-value text-orange-400">--</span><span class="text-xs font-bold text-slate-600">Â°C</span></div>
            </div>
            <div id="card-humi" class="glass-card p-5 border-b-2 border-blue-500/30 draggable-handle" data-id="card-humi">
                <span class="section-title"><div class="w-1.5 h-1.5 rounded-full bg-blue-500"></div>Humidity</span>
                <div class="flex items-baseline justify-center gap-1"><span id="val-humi" class="stat-value text-blue-400">--</span><span class="text-xs font-bold text-slate-600">%</span></div>
            </div>
            <div id="card-co2" class="glass-card p-5 border-b-2 border-purple-500/30 draggable-handle" data-id="card-co2">
                <span class="section-title"><div class="w-1.5 h-1.5 rounded-full bg-purple-500"></div>CO2 Level</span>
                <div class="flex items-baseline justify-center gap-1"><span id="val-co2" class="stat-value text-purple-400">--</span><span class="text-xs font-bold text-slate-600">ppm</span></div>
            </div>
            <div id="card-pm25" class="glass-card p-5 border-b-2 border-rose-500/30 draggable-handle" data-id="card-pm25">
                <span class="section-title"><div class="w-1.5 h-1.5 rounded-full bg-rose-500"></div>PM 2.5</span>
                <div class="flex items-baseline justify-center gap-1"><span id="val-pm25" class="stat-value text-rose-400">--</span><span class="text-xs font-bold text-slate-600">Âµg</span></div>
            </div>
            <div id="card-noise" class="glass-card p-5 border-b-2 border-emerald-500/30 draggable-handle" data-id="card-noise">
                <span class="section-title"><div class="w-1.5 h-1.5 rounded-full bg-emerald-500"></div>Noise</span>
                <div class="flex items-baseline justify-center gap-1"><span id="val-noise" class="stat-value text-emerald-400">--</span><span class="text-xs font-bold text-slate-600">dB</span></div>
            </div>
        </div>

        <main id="sortableMain" class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div id="graph-1" class="lg:col-span-6 glass-card p-6 draggable-handle" data-id="graph-1">
                <div class="flex justify-between items-center mb-4"><span class="section-title mb-0">Env Trend (Temp/Humi)</span><div id="legend-1" class="flex gap-2"></div></div>
                <div class="h-64"><canvas id="ch1"></canvas></div>
            </div>
            <div id="graph-2" class="lg:col-span-6 glass-card p-6 draggable-handle" data-id="graph-2">
                <div class="flex justify-between items-center mb-4"><span class="section-title mb-0">Air Quality & Noise</span><div id="legend-2" class="flex gap-2"></div></div>
                <div class="h-64"><canvas id="ch2"></canvas></div>
            </div>

            <div id="data-logs" class="lg:col-span-8 glass-card p-6 draggable-handle" data-id="data-logs">
                <div class="flex justify-between items-center mb-4">
                    <span class="section-title mb-0">Real-time Sensor Data Logs</span>
                    <button onclick="downloadCSV()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1.5 rounded-lg text-[10px] font-black transition-all flex items-center gap-1">
                        CSV DOWNLOAD
                    </button>
                </div>
                <div class="data-table-container custom-scrollbar">
                    <table id="sensorTable">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Temp</th>
                                <th>Humi</th>
                                <th>CO2</th>
                                <th>PM2.5</th>
                                <th>Noise</th>
                            </tr>
                        </thead>
                        <tbody id="sensorTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="ai-control" class="lg:col-span-4 glass-card p-7 draggable-handle" data-id="ai-control">
                <div class="flex justify-between items-center mb-6"><h2 class="text-xs font-black text-blue-400 uppercase tracking-widest flex items-center gap-2">AI Diagnostic</h2><span id="aiTimer" class="px-2 py-0.5 rounded bg-slate-800 text-[10px] font-mono text-blue-400">60S</span></div>
                <div id="aiContent" class="text-sm text-slate-400 italic mb-6 min-h-[80px]">ëŒ€ê¸° ì¤‘...</div>
                <div class="space-y-4">
                    <span class="section-title">Remote Power Control</span>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="sendCmd('ON')" class="bg-emerald-600 hover:bg-emerald-500 py-4 rounded-xl font-bold transition-all shadow-lg active:scale-95">POWER ON</button>
                        <button onclick="sendCmd('OFF')" class="bg-rose-600 hover:bg-rose-500 py-4 rounded-xl font-bold transition-all shadow-lg active:scale-95">POWER OFF</button>
                    </div>
                    <div class="text-[10px] text-center text-slate-600 font-bold uppercase tracking-widest">Target: <span id="targetLabel" class="text-blue-500 italic">NONE</span></div>
                </div>
            </div>

            <div id="sys-logs" class="lg:col-span-12 glass-card p-6 draggable-handle" data-id="sys-logs">
                <div class="flex justify-between items-center mb-4"><span class="section-title mb-0">System Live Logs</span><button onclick="clearLogs()" class="text-[10px] text-slate-600 uppercase font-bold hover:text-white transition">Clear</button></div>
                <div id="logBoard" class="h-32 overflow-y-auto custom-scrollbar font-mono text-[11px] space-y-1 p-3 bg-black/40 rounded-xl border border-white/5"><div class="text-slate-600 italic">> ëŒ€ì‹œë³´ë“œ í™œì„±í™”ë¨. ê¸°ê¸° ì—°ê²°ì„ ì‹œë„í•˜ì‹­ì‹œì˜¤.</div></div>
            </div>
        </main>
    </div>

    <script>
        let client = null;
        let activeId = "";
        let detectedDevices = new Set();
        let countdown = 60;
        let sensorHistory = []; 
        const apiKey = ""; 

        let chart1, chart2;

        window.onload = () => {
            loadSettings(); 
            initCharts();
            initDraggable();
            if(document.getElementById('mqttHost').value) connect();
            setInterval(tick, 1000);
        };

        function initDraggable() {
            new Sortable(document.getElementById('sortableCards'), { animation: 150, handle: '.draggable-handle', ghostClass: 'opacity-20' });
            new Sortable(document.getElementById('sortableMain'), { animation: 150, handle: '.draggable-handle', ghostClass: 'opacity-20' });
        }

        function togglePanel(id) { document.getElementById(id).classList.toggle('hidden-panel'); }

        function toggleVisibility(id, isVisible) {
            const el = document.getElementById(id);
            if (isVisible) {
                el.classList.remove('hidden-panel');
            } else {
                el.classList.add('hidden-panel');
            }
            // ê·¸ë˜í”„ ë¦¬ì‚¬ì´ì¦ˆ ëŒ€ì‘
            if (id.startsWith('graph')) {
                setTimeout(() => {
                    chart1.resize();
                    chart2.resize();
                }, 310);
            }
        }

        function loadSettings() {
            const defaults = {
                'mqttHost': '4ac86f10b3c3488984c569d3b0f9d4c4.s1.eu.hivemq.cloud',
                'mqttPort': '8884',
                'mqttDataTopic': 'huenrix/sensors/data',
                'mqttCtrlTopic': 'huenrix/control/power'
            };

            ['mqttHost', 'mqttPort', 'mqttUser', 'mqttPass', 'mqttDataTopic', 'mqttCtrlTopic'].forEach(f => {
                const saved = localStorage.getItem(f);
                const el = document.getElementById(f);
                if (saved !== null) {
                    el.value = saved;
                } else if (defaults[f]) {
                    el.value = defaults[f];
                }
            });
        }

        function connect() {
            if(client) { client.end(true); client = null; }
            updateStat('connecting', 'Connecting...');
            const host = document.getElementById('mqttHost').value.trim().replace(/^(wss?:\/\/)/, '');
            const port = document.getElementById('mqttPort').value.trim();
            const url = `wss://${host}:${port}/mqtt`;
            const options = {
                username: document.getElementById('mqttUser').value.trim(),
                password: document.getElementById('mqttPass').value.trim(),
                clientId: 'HUEN_WEB_' + Math.random().toString(16).substr(2, 6),
                clean: true
            };
            try {
                client = mqtt.connect(url, options);
                client.on('connect', () => {
                    updateStat('online', 'Connected');
                    const dataTopic = document.getElementById('mqttDataTopic').value.trim() || "huenrix/sensors/data";
                    client.subscribe(dataTopic);
                    addLog(`MQTT ì„œë²„ ì—°ê²° ë° ìˆ˜ì‹  í† í”½(${dataTopic}) êµ¬ë… ì„±ê³µ`, "success");
                    document.getElementById('configPanel').classList.add('hidden-panel');
                });
                client.on('message', (t, m) => {
                    try {
                        const data = JSON.parse(m.toString());
                        const v = data.values ? data.values[0] : data;
                        const sid = data.sensorID || "ESP32_DEV";
                        if(!detectedDevices.has(sid)) {
                            detectedDevices.add(sid);
                            updateDeviceList();
                            addLog(`ê¸°ê¸° ë°œê²¬: ${sid}`, "success");
                        }
                        if(!activeId) { activeId = sid; document.getElementById('targetLabel').innerText = sid; }
                        if(sid === activeId) {
                            updateUI(v);
                            const now = new Date();
                            const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                            const logEntry = {
                                time: timeStr,
                                fullTime: now.toLocaleString(),
                                temp: v.temperature || v.temp || 0,
                                humi: v.humidity || v.humi || 0,
                                co2: v.co2 || 0,
                                pm25: v.pm25 || v['pm2.5'] || 0,
                                noise: v.noise || 0
                            };
                            sensorHistory.push(logEntry);
                            updateTable(logEntry); 
                            updateCharts(timeStr, logEntry.temp, logEntry.humi, logEntry.co2, logEntry.pm25, logEntry.noise);
                            if(sensorHistory.length > 500) sensorHistory.shift(); 
                        }
                    } catch(e) {}
                });
                client.on('error', (err) => {
                    updateStat('offline', 'Error');
                    addLog("MQTT ì—°ê²° ì˜¤ë¥˜ ë°œìƒ", "error");
                });
            } catch(e) { addLog("ì—°ê²° ë„ì¤‘ ì˜ˆì™¸ ë°œìƒ", "error"); }
        }

        function updateTable(entry) {
            const tbody = document.getElementById('sensorTableBody');
            const row = `<tr>
                <td>${entry.time}</td>
                <td class="text-orange-400 font-bold">${entry.temp}Â°C</td>
                <td class="text-blue-400 font-bold">${entry.humi}%</td>
                <td class="text-purple-400 font-bold">${entry.co2}</td>
                <td class="text-rose-400 font-bold">${entry.pm25}</td>
                <td class="text-emerald-400 font-bold">${entry.noise}</td>
            </tr>`;
            tbody.insertAdjacentHTML('afterbegin', row);
            if(tbody.children.length > 100) tbody.removeChild(tbody.lastChild);
        }

        function downloadCSV() {
            if(sensorHistory.length === 0) {
                addLog("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.", "error");
                return;
            }
            let csv = "Timestamp,Temperature,Humidity,CO2,PM2.5,Noise\n";
            sensorHistory.forEach(row => {
                csv += `${row.fullTime},${row.temp},${row.humi},${row.co2},${row.pm25},${row.noise}\n`;
            });
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `huenrix_data_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            addLog("ë°ì´í„°ê°€ CSV íŒŒì¼ë¡œ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤.", "success");
        }

        function updateDeviceList() {
            const selector = document.getElementById('deviceSelector');
            selector.innerHTML = "";
            detectedDevices.forEach(id => {
                const opt = document.createElement('option');
                opt.value = id; opt.innerText = `ğŸ“¡ ${id}`;
                if(id === activeId) opt.selected = true;
                selector.appendChild(opt);
            });
        }

        function changeDevice(id) {
            activeId = id;
            sensorHistory = [];
            document.getElementById('sensorTableBody').innerHTML = "";
            document.getElementById('targetLabel').innerText = id;
            addLog(`ëŒ€ìƒ ê¸°ê¸° ë³€ê²½: [${id}] (ë¡œê·¸ ì´ˆê¸°í™”)`, "info");
        }

        function updateUI(v) {
            const getV = (keys) => { for(let k of keys) if(v[k] !== undefined) return v[k]; return 0; };
            document.getElementById('val-temp').innerText = getV(['temperature', 'temp']);
            document.getElementById('val-humi').innerText = getV(['humidity', 'humi']);
            document.getElementById('val-co2').innerText = getV(['co2']);
            document.getElementById('val-pm25').innerText = getV(['pm25', 'pm2.5']);
            document.getElementById('val-noise').innerText = getV(['noise']);
        }

        function initCharts() {
            const ctx1 = document.getElementById('ch1').getContext('2d');
            chart1 = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Temp', borderColor: '#fb923c', data: [], yAxisID: 'y_temp', tension: 0.3, pointRadius: 0, borderWidth: 2 },
                        { label: 'Humi', borderColor: '#3b82f6', data: [], yAxisID: 'y_humi', tension: 0.3, pointRadius: 0, borderWidth: 2 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: true, grid: { display: false }, ticks: { color: '#475569', font: { size: 9 }, maxRotation: 0, autoSkip: true, maxTicksLimit: 5 } },
                        y_temp: { type: 'linear', position: 'left', grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#fb923c', font: { size: 9 } } },
                        y_humi: { type: 'linear', position: 'right', grid: { display: false }, ticks: { color: '#3b82f6', font: { size: 9 } } }
                    }
                }
            });
            const ctx2 = document.getElementById('ch2').getContext('2d');
            chart2 = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'CO2', borderColor: '#a855f7', data: [], yAxisID: 'y_co2', tension: 0.3, pointRadius: 0, borderWidth: 2 },
                        { label: 'PM2.5', borderColor: '#f43f5e', data: [], yAxisID: 'y_pm', tension: 0.3, pointRadius: 0, borderWidth: 2 },
                        { label: 'Noise', borderColor: '#10b981', data: [], yAxisID: 'y_noise', tension: 0.3, pointRadius: 0, borderWidth: 2 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: true, grid: { display: false }, ticks: { color: '#475569', font: { size: 9 }, maxRotation: 0, autoSkip: true, maxTicksLimit: 5 } },
                        y_co2: { type: 'linear', position: 'left', grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#a855f7', font: { size: 9 } } },
                        y_pm: { type: 'linear', position: 'right', grid: { display: false }, ticks: { color: '#f43f5e', font: { size: 9 } } },
                        y_noise: { type: 'linear', position: 'right', grid: { display: false }, ticks: { color: '#10b981', font: { size: 9 } } }
                    }
                }
            });
            createLegend('legend-1', chart1);
            createLegend('legend-2', chart2);
        }

        function createLegend(containerId, chart) {
            const container = document.getElementById(containerId);
            chart.data.datasets.forEach((ds, i) => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `<input type="checkbox" checked id="check-${containerId}-${i}" style="accent-color:${ds.borderColor}"><label for="check-${containerId}-${i}" style="color:${ds.borderColor}">${ds.label}</label>`;
                item.onclick = () => {
                    const meta = chart.getDatasetMeta(i);
                    meta.hidden = meta.hidden === null ? !chart.data.datasets[i].hidden : null;
                    chart.update();
                };
                container.appendChild(item);
            });
        }

        function updateCharts(time, t, h, c, p, n) {
            [chart1, chart2].forEach(chart => {
                chart.data.labels.push(time);
                if(chart.data.labels.length > 50) { chart.data.labels.shift(); chart.data.datasets.forEach(d => d.data.shift()); }
            });
            chart1.data.datasets[0].data.push(t);
            chart1.data.datasets[1].data.push(h);
            chart2.data.datasets[0].data.push(c);
            chart2.data.datasets[1].data.push(p);
            chart2.data.datasets[2].data.push(n);
            chart1.update('none'); chart2.update('none');
        }

        function tick() {
            if(!client || !client.connected) return;
            countdown--;
            document.getElementById('aiTimer').innerText = `${countdown}S`;
            if(countdown <= 0) { countdown = 60; analyze(); }
        }

        async function analyze() {
            if(sensorHistory.length < 2) return;
            const l = sensorHistory[sensorHistory.length - 1];
            document.getElementById('aiContent').innerText = "AI ë¶„ì„ ì§„í–‰ ì¤‘...";
            try {
                const prompt = `Env: T ${l.temp}, H ${l.humi}, CO2 ${l.co2}, PM2.5 ${l.pm25}, Noise ${l.noise}. ì „ë¬¸ê°€ë¡œì„œ í•œêµ­ì–´ë¡œ ì§§ê³  ì¹œì ˆí•œ ì¡°ì–¸ í•œ ë¬¸ì¥ë§Œ í•´ì¤˜.`;
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                document.getElementById('aiContent').innerText = data.candidates?.[0]?.content?.parts?.[0]?.text || "ë¶„ì„ ë¶ˆê°€";
            } catch(e) { document.getElementById('aiContent').innerText = "AI ì„œë²„ ì—°ê²° ì¼ì‹œ ì˜¤ë¥˜"; }
        }

        function sendCmd(val) {
            if(!client || !client.connected || !activeId) {
                addLog("ì˜¤ë¥˜: MQTT ë¯¸ì—°ê²° ë˜ëŠ” ê¸°ê¸° ë¯¸ì„ íƒ", "error");
                return;
            }
            const controlTopic = document.getElementById('mqttCtrlTopic').value.trim() || "huenrix/control/power";
            const payload = JSON.stringify({ command: "POWER", value: val, sensorID: activeId, timestamp: new Date().toISOString() });
            client.publish(controlTopic, payload);
            addLog(`[${activeId}] POWER ${val} ëª…ë ¹ ì „ì†¡`, "success");
        }

        function addLog(m, s) {
            const b = document.getElementById('logBoard');
            const color = s === 'success' ? 'text-emerald-400' : s === 'error' ? 'text-rose-400' : 'text-blue-400';
            b.insertAdjacentHTML('afterbegin', `<div class="${color}">[${new Date().toLocaleTimeString()}] ${m}</div>`);
        }
        function clearLogs() { document.getElementById('logBoard').innerHTML = ""; }
        function updateStat(s, m) { document.getElementById('connStatus').className = `status-pulse ${s}`; document.getElementById('statusText').innerText = m; }
        
        function saveAndReconnect() { 
            ['mqttHost', 'mqttPort', 'mqttUser', 'mqttPass', 'mqttDataTopic', 'mqttCtrlTopic'].forEach(f => {
                localStorage.setItem(f, document.getElementById(f).value);
            });
            connect(); 
        }
    </script>
</body>

</html>
